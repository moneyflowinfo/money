<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Money Flow ë¯¸êµ­ ì£¼ì‹</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --accent: #3b82f6;
      --positive: #10b981;
      --negative: #ef4444;
      --header-bg: rgba(15, 23, 42, 0.92); /* ë‹¤í¬ ë°°ê²½ ê¸°ë³¸ */
    }

    [data-theme="light"] {
      --bg-primary: #f9fafb;
      --bg-secondary: #ffffff;
      --text-primary: #111827;
      --text-secondary: #4b5563;
      --accent: #2563eb;
      --positive: #047857;
      --negative: #b91c1c;
      --header-bg: rgba(30, 41, 59, 0.92); /* ë¼ì´íŠ¸ ëª¨ë“œì—ì„œë„ í—¤ë”ëŠ” ë‹¤í¬í•˜ê²Œ ìœ ì§€ */
    }

    body { background: var(--bg-primary); color: var(--text-primary); font-family: system-ui, sans-serif; margin: 0; min-height: 100vh; }
    header {
      background: var(--header-bg);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid #334155;
      position: sticky;
      top: 0;
      z-index: 50;
      padding: 0.75rem 1.5rem;
    }
    .header-container {
      max-width: 1680px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .title-section { text-align: center; flex: 1; }
    h1, .subtitle, .usd-info, #last-updated {
      color: #ffffff !important; /* í—¤ë” í…ìŠ¤íŠ¸ í•­ìƒ í°ìƒ‰ìœ¼ë¡œ ê°•ì œ (ë¼ì´íŠ¸ ëª¨ë“œì—ì„œë„ ë³´ì´ê²Œ) */
    }
    h1 { font-size: 1.8rem; margin: 0; }
    .subtitle { font-size: 0.875rem; margin-top: 0.25rem; }
    .right-section {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }
    .usd-info { font-size: 0.875rem; white-space: nowrap; }
    .usd-info strong { font-weight: 600; }
    main { max-width: 1680px; margin: 0 auto; padding: 1.5rem 1rem 3rem; }
    .tables-wrapper { display: flex; flex-direction: column; gap: 3rem; }
    @media (min-width: 1024px) { .tables-wrapper { flex-direction: row; gap: 2rem; } .table-section { flex: 1; min-width: 0; } }
    .section-title { font-size: 1.4rem; font-weight: bold; text-align: center; margin: 0 0 1rem; position: relative; }
    .section-title::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 120px; height: 3px; background: linear-gradient(to right, var(--accent), #60a5fa); border-radius: 2px; }
    .table-container { overflow-x: auto; background: var(--bg-secondary); border: 1px solid #334155; border-radius: 10px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.80rem; table-layout: auto; }
    th, td { padding: 0.65rem 0.9rem; text-align: left; white-space: nowrap; border-bottom: 1px solid #2d3748; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
    th { background: var(--bg-primary); color: var(--text-secondary); font-weight: 600; position: sticky; top: 0; z-index: 10; }
    tr:hover { background: rgba(59, 130, 246, 0.08); }
    .positive { color: var(--positive); }
    .negative { color: var(--negative); }

    .filter-bar { background: var(--bg-secondary); padding: 0.75rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #334155; overflow-x: auto; }
    .filter-row { display: flex; align-items: center; gap: 0.75rem; flex-wrap: nowrap; }
    .filter-item { display: flex; flex-direction: column; min-width: 120px; }
    .filter-item label { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
    .filter-item input, .filter-item select { background: var(--bg-primary); color: var(--text-primary); border: 1px solid #334155; border-radius: 5px; padding: 0.4rem 0.6rem; font-size: 0.85rem; }
    .filter-item input::placeholder { color: #64748b; }
  </style>
</head>
<body>

  <header>
    <div class="header-container">
      <div class="title-section">
        <h1>Money Flow ë¯¸êµ­ ì£¼ì‹</h1>
        <div class="subtitle">ì´ë™ í‰ê· ì„ ìœ¼ë¡œ ë³´ëŠ” ëˆì˜ íë¦„</div>
      </div>
      <div class="right-section">
        <div class="usd-info">
          $ ì›/ë‹¬ëŸ¬ í™˜ìœ¨: <strong id="usdkrw-value">â€”</strong>
          <span id="last-updated" style="margin-left: 1rem;">Updated: ë¡œë”© ì¤‘...</span>
        </div>
        <button id="theme-toggle" class="p-2 rounded hover:bg-gray-800">
          <i id="theme-icon" class="fas fa-moon text-lg"></i>
        </button>
      </div>
    </div>
  </header>

  <main>
    <div class="tables-wrapper">

      <div class="table-section">
        <h2 class="section-title">âœ… ì™„ë²½ ì •ë°°ì—´</h2>

        <div class="filter-bar">
          <div class="filter-row">
            <div class="filter-item">
              <label>í‹°ì»¤</label>
              <input type="text" id="perfect-ticker" placeholder="ë¶€ë¶„ ì…ë ¥" />
            </div>
            <div class="filter-item">
              <label>í˜„ì¬ê°€</label>
              <select id="perfect-price">
                <option value="">ì „ì²´</option>
                <option value="< $100">< $100</option>
                <option value="$100~200">$100~200</option>
                <option value="$200~300">$200~300</option>
                <option value="$300~500">$300~500</option>
                <option value="$500+">$500+</option>
              </select>
            </div>
            <div class="filter-item">
              <label>ìƒíƒœ/ëŒíŒŒ</label>
              <select id="perfect-status">
                <option value="">ì „ì²´</option>
                <option value="ì •ë°°ì—´ / ì‹ ê·œì§„ì…">ì •ë°°ì—´ / ì‹ ê·œì§„ì…</option>
              </select>
            </div>
            <div class="filter-item">
              <label>RSI(ì¼)</label>
              <select id="perfect-rsi-day">
                <option value="">ì „ì²´</option>
                <option value="70â†‘">70â†‘</option>
                <option value="60~70">60~70</option>
                <option value="50~60">50~60</option>
                <option value="40~50">40~50</option>
                <option value="30â†“">30â†“</option>
              </select>
            </div>
            <div class="filter-item">
              <label>RSI(ì£¼)</label>
              <select id="perfect-rsi-week">
                <option value="">ì „ì²´</option>
                <option value="70â†‘">70â†‘</option>
                <option value="60~70">60~70</option>
                <option value="50~60">50~60</option>
                <option value="40~50">40~50</option>
                <option value="30â†“">30â†“</option>
              </select>
            </div>
            <div class="filter-item" data-type="sector">
              <label>ì„¹í„°</label>
              <select id="perfect-sector">
                <option value="">ì „ì²´</option>
              </select>
            </div>
          </div>
        </div>

        <div class="table-container">
          <p id="perfect-loading" class="text-center py-12 text-lg">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
          <table id="perfect-table" class="hidden">
            <thead><tr></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="table-section">
        <h2 class="section-title">ğŸš€ ìƒìŠ¹ ëŒíŒŒ ì‹œë„ì¤‘</h2>

        <div class="filter-bar">
          <div class="filter-row">
            <div class="filter-item">
              <label>í‹°ì»¤</label>
              <input type="text" id="breakout-ticker" placeholder="ë¶€ë¶„ ì…ë ¥" />
            </div>
            <div class="filter-item">
              <label>í˜„ì¬ê°€</label>
              <select id="breakout-price">
                <option value="">ì „ì²´</option>
                <option value="< $100">< $100</option>
                <option value="$100~200">$100~200</option>
                <option value="$200~300">$200~300</option>
                <option value="$300~500">$300~500</option>
                <option value="$500+">$500+</option>
              </select>
            </div>
            <div class="filter-item">
              <label>ìƒíƒœ/ëŒíŒŒ</label>
              <select id="breakout-status">
                <option value="">ì „ì²´</option>
                <option value="200ì¼ì„  ëŒíŒŒ">200ì¼ì„  ëŒíŒŒ</option>
                <option value="60ì¼ì„  ëŒíŒŒ">60ì¼ì„  ëŒíŒŒ</option>
                <option value="ê·¼ì²˜ ë°˜ë“±">ê·¼ì²˜ ë°˜ë“±</option>
                <option value="ê°•í•œ ëŒíŒŒ">ê°•í•œ ëŒíŒŒ</option>
              </select>
            </div>
            <div class="filter-item">
              <label>RSI(ì¼)</label>
              <select id="breakout-rsi-day">
                <option value="">ì „ì²´</option>
                <option value="70â†‘">70â†‘</option>
                <option value="60~70">60~70</option>
                <option value="50~60">50~60</option>
                <option value="40~50">40~50</option>
                <option value="30â†“">30â†“</option>
              </select>
            </div>
            <div class="filter-item">
              <label>RSI(ì£¼)</label>
              <select id="breakout-rsi-week">
                <option value="">ì „ì²´</option>
                <option value="70â†‘">70â†‘</option>
                <option value="60~70">60~70</option>
                <option value="50~60">50~60</option>
                <option value="40~50">40~50</option>
                <option value="30â†“">30â†“</option>
              </select>
            </div>
            <div class="filter-item" data-type="sector">
              <label>ì„¹í„°</label>
              <select id="breakout-sector">
                <option value="">ì „ì²´</option>
              </select>
            </div>
          </div>
        </div>

        <div class="table-container">
          <p id="breakout-loading" class="text-center py-12 text-lg">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
          <table id="breakout-table" class="hidden">
            <thead><tr></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </div>
  </main>

  <script>
    // í…Œë§ˆ í† ê¸€
    const toggleBtn = document.getElementById('theme-toggle');
    const icon = document.getElementById('theme-icon');
    const html = document.documentElement;

    toggleBtn.addEventListener('click', () => {
      if (html.getAttribute('data-theme') === 'dark') {
        html.setAttribute('data-theme', 'light');
        icon.classList.replace('fa-moon', 'fa-sun');
      } else {
        html.setAttribute('data-theme', 'dark');
        icon.classList.replace('fa-sun', 'fa-moon');
      }
    });

    // í—¤ë” ì •ë³´ ì—…ë°ì´íŠ¸ (í™˜ìœ¨ + CSV ìˆ˜ì • ì‹œê°„)
    async function updateHeaderInfo() {
      const csvUrl = 'https://raw.githubusercontent.com/moneyflowinfo/moneynew/master/market_data_analysis.csv';

      try {
        const csvRes = await fetch(csvUrl, { method: 'HEAD' });
        const lastModified = csvRes.headers.get('last-modified');
        let updatedText = 'ì•Œ ìˆ˜ ì—†ìŒ';
        if (lastModified) {
          const date = new Date(lastModified);
          updatedText = date.toLocaleString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', hour12: false
          });
        }
        document.getElementById('last-updated').textContent = `Updated: ${updatedText}`;

        const rateRes = await fetch('https://open.er-api.com/v6/latest/USD');
        const rateData = await rateRes.json();
        if (rateData.result === 'success' && rateData.rates?.KRW) {
          const krw = rateData.rates.KRW.toFixed(2);
          document.getElementById('usdkrw-value').textContent = `${krw}ì›`;
        } else {
          document.getElementById('usdkrw-value').textContent = 'í™•ì¸ ì¤‘...';
        }
      } catch (e) {
        console.error(e);
        document.getElementById('last-updated').textContent = 'ì˜¤ë¥˜';
        document.getElementById('usdkrw-value').textContent = 'ì˜¤ë¥˜';
      }
    }

    function applyTableFilters(tableId) {
      const prefix = tableId.replace('-table', '');
      const tickerValue = document.getElementById(prefix + '-ticker')?.value.trim().toLowerCase() || '';
      const priceValue = document.getElementById(prefix + '-price')?.value || '';
      const statusValue = document.getElementById(prefix + '-status')?.value || '';
      const rsiDayValue = document.getElementById(prefix + '-rsi-day')?.value || '';
      const rsiWeekValue = document.getElementById(prefix + '-rsi-week')?.value || '';
      const sectorValue = document.getElementById(prefix + '-sector')?.value || '';

      const table = document.getElementById(tableId);
      const rows = table.querySelectorAll('tbody tr');

      rows.forEach(row => {
        let show = true;

        if (tickerValue && row.children[0]) {
          if (!row.children[0].textContent.trim().toLowerCase().includes(tickerValue)) show = false;
        }

        if (priceValue && show && row.children[1]) {
          const p = parseFloat(row.children[1].textContent.trim().replace(/[\$,]/g, ''));
          if (!isNaN(p)) {
            if (priceValue === '< $100' && p >= 100) show = false;
            else if (priceValue === '$100~200' && (p < 100 || p >= 200)) show = false;
            else if (priceValue === '$200~300' && (p < 200 || p >= 300)) show = false;
            else if (priceValue === '$300~500' && (p < 300 || p >= 500)) show = false;
            else if (priceValue === '$500+' && p < 500) show = false;
          } else {
            show = false;
          }
        }

        if (statusValue && show && row.children[3]) {
          if (row.children[3].textContent.trim() !== statusValue) show = false;
        }

        if (rsiDayValue && show && row.children[4]) {
          const v = parseFloat(row.children[4].textContent.trim());
          if (!isNaN(v)) {
            if (rsiDayValue === '70â†‘' && v < 70) show = false;
            else if (rsiDayValue === '60~70' && (v < 60 || v >= 70)) show = false;
            else if (rsiDayValue === '50~60' && (v < 50 || v >= 60)) show = false;
            else if (rsiDayValue === '40~50' && (v < 40 || v >= 50)) show = false;
            else if (rsiDayValue === '30â†“' && v > 30) show = false;
          }
        }

        if (rsiWeekValue && show && row.children[5]) {
          const v = parseFloat(row.children[5].textContent.trim());
          if (!isNaN(v)) {
            if (rsiWeekValue === '70â†‘' && v < 70) show = false;
            else if (rsiWeekValue === '60~70' && (v < 60 || v >= 70)) show = false;
            else if (rsiWeekValue === '50~60' && (v < 50 || v >= 60)) show = false;
            else if (rsiWeekValue === '40~50' && (v < 40 || v >= 50)) show = false;
            else if (rsiWeekValue === '30â†“' && v > 30) show = false;
          }
        }

        if (sectorValue && show && row.children[7]) {
          if (row.children[7].textContent.trim() !== sectorValue) show = false;
        }

        row.style.display = show ? '' : 'none';
      });
    }

    function populateTable(tableId, loadingId, headers, data) {
      const table = document.getElementById(tableId);
      const loading = document.getElementById(loadingId);

      if (!data || data.length === 0) {
        loading.textContent = 'í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }

      const thead = table.querySelector('thead tr');
      thead.innerHTML = '';
      headers.slice(1, -1).forEach(header => {
        const th = document.createElement('th');
        th.textContent = header.trim();
        thead.appendChild(th);
      });

      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';
      data.forEach(row => {
        const tr = document.createElement('tr');
        row.slice(1, -1).forEach(cell => {
          const td = document.createElement('td');
          td.textContent = cell.trim();
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      const sectorSelect = document.getElementById(tableId.replace('table', 'sector'));
      if (sectorSelect) {
        const sectors = new Set();
        data.forEach(row => {
          const sector = row[8]?.trim();
          if (sector) sectors.add(sector);
        });
        sectors.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          sectorSelect.appendChild(opt);
        });
      }

      loading.style.display = 'none';
      table.classList.remove('hidden');

      // í…Œì´ë¸” ë¡œë“œ í›„ í•„í„° ì¦‰ì‹œ ì ìš© (ì´ ë¶€ë¶„ì´ í•µì‹¬!)
      applyTableFilters(tableId);
    }

    async function loadCsvData() {
      const url = 'https://raw.githubusercontent.com/moneyflowinfo/moneynew/master/market_data_analysis.csv';
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('CSV ë¡œë“œ ì‹¤íŒ¨');
        const text = await res.text();
        const rows = text.trim().split('\n').map(r => r.split(','));
        const headers = rows.shift();
        const signalIdx = headers.length - 1;

        const perfect = rows.filter(r => r[signalIdx]?.trim() === 'ì™„ë²½ ì •ë°°ì—´');
        const breakout = rows.filter(r => r[signalIdx]?.trim() === 'ìƒìŠ¹ ëŒíŒŒ ì‹œë„ì¤‘');

        populateTable('perfect-table', 'perfect-loading', headers, perfect);
        populateTable('breakout-table', 'breakout-loading', headers, breakout);

        updateHeaderInfo();
      } catch (e) {
        console.error(e);
        document.getElementById('perfect-loading').textContent = 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨';
        document.getElementById('breakout-loading').textContent = 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadCsvData();

      ['perfect', 'breakout'].forEach(prefix => {
        const elements = [
          document.getElementById(prefix + '-ticker'),
          document.getElementById(prefix + '-price'),
          document.getElementById(prefix + '-status'),
          document.getElementById(prefix + '-rsi-day'),
          document.getElementById(prefix + '-rsi-week'),
          document.getElementById(prefix + '-sector')
        ];

        elements.forEach(el => {
          if (el) {
            const eventType = el.tagName === 'INPUT' ? 'input' : 'change';
            el.addEventListener(eventType, () => applyTableFilters(prefix + '-table'));
          }
        });
      });
    });

    async function updateHeaderInfo() {
      const csvUrl = 'https://raw.githubusercontent.com/moneyflowinfo/moneynew/master/market_data_analysis.csv';

      try {
        const csvRes = await fetch(csvUrl, { method: 'HEAD' });
        const lastModified = csvRes.headers.get('last-modified');
        let updatedText = 'ì•Œ ìˆ˜ ì—†ìŒ';
        if (lastModified) {
          const date = new Date(lastModified);
          updatedText = date.toLocaleString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', hour12: false
          });
        }
        document.getElementById('last-updated').textContent = `Updated: ${updatedText}`;

        const rateRes = await fetch('https://open.er-api.com/v6/latest/USD');
        const rateData = await rateRes.json();
        if (rateData.result === 'success' && rateData.rates?.KRW) {
          const krw = rateData.rates.KRW.toFixed(2);
          document.getElementById('usdkrw-value').textContent = `${krw}ì›`;
        } else {
          document.getElementById('usdkrw-value').textContent = 'í™•ì¸ ì¤‘...';
        }
      } catch (e) {
        console.error(e);
        document.getElementById('last-updated').textContent = 'ì˜¤ë¥˜';
        document.getElementById('usdkrw-value').textContent = 'ì˜¤ë¥˜';
      }
    }
  </script>

</body>
</html>